<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title></title>
    <meta name="description" content="">
    <meta name="keywords" content="Python, Keras, Tensorflow, Image Classification, Kaggle">
    <meta name="author" content="Nguyễn Kim Bảo (BaoIT)">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com/">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.41.1/apexcharts.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.8/sweetalert2.min.css">
    <script src="static/common.js"></script>
</head>

<body>
    <input id="choose_project" type="hidden" value="4" />
    <div class="container-fluid d-flex max-vh-100 max-vw-100 justify-content-between">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-5 col-sm-12">
                    <h4 class="text-danger fw-bold text-center pt-2 pb-1" style="font-size: 28px;margin: 0;"></h4>
                    <p class="text-center text-secondary">&copy; 2024 BaoIT. All right reserved.</p>
                    <p class="text-center pb-1">Dataset URL: <a id="ds-info" href="#" class="text-decoration-none"
                            target="_blank"></a>
                    </p>
                    <div class="row">
                        <div class="col-6">
                            <a href="#" class="btn btn-primary d-block float-end" onclick="chooseInput('video');">Video
                                file</a>
                        </div>
                        <div class="col-6">
                            <a href="#" class="btn btn-danger" onclick="chooseInput('webcam');">Webcam</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="webcam" style="display: none;">
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="ratio ratio-16x9">
                                            <!--<video width="100%" height="100%"></video>--->
                                            <video width="640" height="480" autoplay></video>
                                            <canvas width="640" height="480"></canvas>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div id="video-file" style="display: none;">
                                <div class="row mt-3">
                                    <div class="col">
                                        <input type="file" class="form-control" name="file"
                                            onchange="detectVideoFile();" required />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-primary" onclick="playVideo();">Phát</button>
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-danger" onclick="stopVideo();">Dừng</button>
                                    </div>
                                    <div class="col-12 pt-4">
                                        <div class="ratio ratio-16x9">
                                            <video width="640" height="480" autoplay muted></video>
                                            <canvas width="640" height="480"></canvas>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.41.1/apexcharts.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.17.0/tf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.8/sweetalert2.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

        <script>
            if (window.history.replaceState) {
                window.history.replaceState(null, null, window.location.href);
            }
        </script>
        <script>loadDOM($("input#choose_project").val());</script>
        <script>
            async function loadModel() {
                /**
                Tải mô hình COCO SSD
                */
                try {
                    let model = await cocoSsd.load();
                    return model;
                } catch (e) {
                    console.log(`Lỗi tải mô hình COCO SSD ! ${e}`);
                    thongBao(`Lỗi tải mô hình COCO SSD ! ${e}`);
                }

            }

            function detectVideoFile() {
                let wrong = false;
                let file = event.target.files[0];
                // Kiểm tra tệp có phải là video hay không ?
                if (file.type.split('/')[0] !== 'video') {
                    thongBao('Tệp tải lên phải là video !', 'warning');
                    wrong = true;
                }
                // Kiểm tra dung lượng tệp tải lên
                if (file.size > 100000000000000000) {
                    thongBao('Dung lượng của ảnh phải < 100MB !', 'warning');
                    wrong = true;
                }
                // Nếu không có lỗi thì tiếp tục
                if (!wrong) {
                    let video = $("#video-file video")[0];
                    let canvas = $("#video-file canvas")[0];
                    let context = canvas.getContext('2d');
                    // Reset tham số src và box
                    video.src = '';
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    // Bắt đầu khởi tạo đường dẫn từ tệp video đã tải lên
                    let videoUrl = URL.createObjectURL(file);
                    video.src = videoUrl;

                    // Load meta của video & bắt đầu chạy dự đoán
                    video.onloadedmetadata = async () => {
                        await video.play();
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        runDetect(video, canvas);
                    };
                }
            }
            async function detectObjects(model, video) {
                /**
                Phát hiện đối tượng trên từng frame
                */
                let predictions = await model.detect(video);
                return predictions;
            }

            function drawBoxes(predictions, canvas) {
                /**
                Vẽ bounding box lên frame canvas
                */
                let context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
                predictions.forEach(prediction => {
                    // Lấy tọa độ box [x, y, w, h]
                    let [x, y, w, h] = prediction.bbox;
                    // Lấy độ tin cậy của box (2 chữ số thập phân)
                    let score = prediction.score.toFixed(2);
                    context.beginPath();
                    // Bắt đầu vẽ bouding box
                    context.rect(x, y, w, h);
                    // Quy định độ dày & màu sắc của đường viền
                    context.lineWidth = 3;
                    context.strokeStyle = 'green';
                    context.fillStyle = 'green';
                    context.stroke();
                    // In text lên box
                    context.font = '16px Arial';
                    context.fillStyle = "yellow";
                    context.fillText(`${prediction.class} ${score}`, x, y - 5);
                });
            }

            async function setupWebcam() {
                /**
                Bắt đầu đọc Webcam
                */
                let video = $("#webcam video")[0];
                if (navigator.mediaDevices.getUserMedia) {
                    let stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "environment",
                            width: 1280,
                            height: 720
                        },
                        audio: false
                    });
                    video.srcObject = stream;
                    mediaStream = stream;
                    return new Promise(resolve => {
                        video.onloadedmetadata = () => {
                            resolve(video);
                        };
                    });
                } else {
                    thongBao("Không thể khởi động webcam. Thử lại !", "error");
                }
            }

            async function runDetect(video, canvas) {
                /**
                Bắt đầu quá trình phát hiện đối tượng
                @param video Video đầu vào
                @param canvas Canvas là video đầu ra sau khi dự đoán & vẽ box đối tượng
                */
                let model = await loadModel();
                video.play();
                let context = canvas.getContext('2d');
                // Đặt kích thước canvas tương tự video đầu vào
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                // Bắt đầu quá trình detect 
                async function detect() {
                    // Phát hiện đối tượng
                    let predictions = await detectObjects(model, video);
                    // Vẽ bounding box
                    drawBoxes(predictions, canvas);
                    // Tiếp tục quá trình phát hiện
                    requestAnimationFrame(detect);
                }
                detect();
            }


        </script>
        <script>
            let webcamStream;
            function playVideo() {
                $("#video-file video")[0].play();
            }

            function stopVideo() {
                $("#video-file video")[0].pause();
            }

            function stopWebcam() {
                if (webcamStream) {
                    let video = $("#webcam video")[0];
                    // Dừng các track
                    webcamStream.getTracks().forEach(track => {
                        track.stop();
                    });

                    // Xóa dữ liệu biến
                    webcamStream = null;

                    // Dừng video & xóa src
                    video.pause();
                    video.srcObject = null;
                }
            }

            async function chooseInput(i_type) {
                document.getElementById("video-file").style.display = "none";
                document.getElementById("webcam").style.display = "none";

                if (i_type == "video") {
                    stopWebcam();
                    document.getElementById("video-file").style.display = "block";
                }

                if (i_type == "webcam") {
                    stopVideo();
                    document.getElementById("webcam").style.display = "block";
                    let video = await setupWebcam();
                    let canvas = $("#webcam canvas")[0];
                    canvas.width = video.width
                    canvas.height = video.height;
                    video.play();
                    runDetect(video, canvas);
                }
            }
        </script>

</body>

</html>